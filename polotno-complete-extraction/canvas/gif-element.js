var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.GifElement=void 0;const t=e(require("react")),a=require("mobx-react-lite"),r=require("mobx"),i=require("react-konva"),n=e(require("konva")),o=require("gifuct-js"),d=require("./video-element"),l=require("./image-element"),h=require("./apply-filters"),s=require("./use-fadein"),c=require("../utils/screen");function u(e,t,a){const r=t.getContext("2d"),i=a.getContext("2d");if(!r||!i){return}2===e.disposalType&&r.clearRect(0,0,t.width,t.height),a.width=e.width,a.height=e.height;const n=i.createImageData(e.width,e.height);n.data.set(e.patch),i.putImageData(n,0,0),r.drawImage(a,e.left,e.top)}const f=(0,a.observer)((({element:e})=>{const a=Math.min(30,e.width/4,e.height/4),r=t.default.useRef(null);return t.default.useEffect((()=>{const e=r.current;if(!e){return}const t=new n.default.Animation((t=>{e.rotate(((null==t?void 0:t.timeDiff)||0)/2)}),e.getLayer());return t.start(),()=>{t.stop()}}),[]),t.default.createElement(i.Group,{x:e.a.x,y:e.a.y,rotation:e.a.rotation,listening:!1,opacity:e.a.opacity,hideInExport:!e.showInExport},t.default.createElement(i.Rect,{width:e.width,height:e.height,fill:"rgba(124, 173, 212, 0.8)"}),t.default.createElement(i.Arc,{ref:r,x:e.width/2,y:e.height/2,fill:"white",outerRadius:Math.abs(a),innerRadius:Math.max(1,a-5),angle:270}))})),g=(0,a.observer)((({element:e})=>{const a=Math.max(10,Math.min(30,e.width/22));return t.default.createElement(i.Group,{x:e.a.x,y:e.a.y,rotation:e.a.rotation,listening:!1,opacity:e.a.opacity,hideInExport:!e.showInExport},t.default.createElement(i.Rect,{width:e.width,height:e.height,fill:"rgba(223, 102, 102, 0.8)"}),t.default.createElement(i.Text,{text:"Cannot load the GIF...",fontSize:a,width:e.width,height:e.height,align:"center",fill:"white",verticalAlign:"middle",padding:5}))}));exports.GifElement=(0,a.observer)((({element:e,store:a})=>{var m;const[p,w]=t.default.useState(!1),y=a.selectedShapes.indexOf(e)>=0&&e.selectable,x=t.default.useRef(null),E=t.default.useRef(),[b,v,I,R]=function(e){const[a,r]=t.default.useState([]),[i,n]=t.default.useState(0),[d,l]=t.default.useState("loading"),[h,s]=t.default.useState({width:0,height:0});return t.default.useEffect((()=>{(async()=>{try{const t=await fetch(e),a=await t.arrayBuffer(),i=(0,o.parseGIF)(a),d=(0,o.decompressFrames)(i,!0),h=i.lsd.width,c=i.lsd.height;s({width:h,height:c});const u=d.map((e=>({patch:new Uint8ClampedArray(e.patch),delay:e.delay,width:e.dims.width,height:e.dims.height,left:e.dims.left,top:e.dims.top,disposalType:e.disposalType}))),f=u.reduce(((e,t)=>e+t.delay),0);r(u),n(f),l("loaded")}catch(t){console.error("Failed to load GIF:",t),l("failed")}})()}),[e]),[a,i,h,d]}(e.src);(0,l.useImageLoader)(R,e.src,e.id),t.default.useEffect((()=>(E.current=document.createElement("canvas"),()=>{E.current&&n.default.Util.releaseCanvas(E.current)})),[]),t.default.useEffect((()=>{if("loaded"===R&&E.current&&(E.current.width=I.width,E.current.height=I.height,b.length>0)){const e=E.current.getContext("2d");if(e){e.clearRect(0,0,I.width,I.height);const t=document.createElement("canvas");u(b[0],E.current,t)}}}),[I,R,b]),t.default.useEffect((()=>{if(!b.length||!E.current){return}const t=E.current;t.width=I.width,t.height=I.height;const i=document.createElement("canvas"),n=t.getContext("2d");n&&n.clearRect(0,0,t.width,t.height);let o=-1;u(b[0],t,i),F(),o=0;const d=e=>{const a=(e=>{const t=e%v;let a=0;for(let r=0;r<b.length;r++){if(a+=b[r].delay,a>t){return r}}return 0})(e);a!==o&&(u(b[a],t,i),F(),x.current.getLayer().draw(),o=a)};if(a.isPlaying||e.page._exportingOrRendering){return(0,r.autorun)((()=>{d(a.currentTime-e.page.startTime)}))}{const e=window.setInterval((()=>{d(a.currentTime||performance.now())}),16);return()=>{clearInterval(e)}}}),[a.isPlaying,b,v,e.page._exportingOrRendering]),t.default.useEffect((()=>{v&&a.history.ignore((()=>{e.set({duration:v})}))}),[v]);let{cropX:M,cropY:S,cropWidth:C,cropHeight:T}=e;"loaded"!==R&&(M=S=0,C=T=1);const _={x:I.width*M,y:I.height*S,width:I.width*C,height:I.height*T},q=null!==(m=e.cornerRadius)&&void 0!==m?m:0,[O,F]=(0,d.useCornerRadiusAndCrop)(e,E.current,_,a._elementsPixelRatio,q,p||e._cropModeEnabled);t.default.useLayoutEffect((()=>{if(!p&&!e._cropModeEnabled&&x.current){return(0,h.applyFilter)(x.current,e),(0,r.autorun)((()=>{(0,h.applyFilter)(x.current,e)}),{delay:100})}}),[E.current,p,C,T,e._cropModeEnabled,I.width,I.height]);const z="loading"===R,D="failed"===R,G=z||D?0:e.a.opacity;(0,s.useFadeIn)(x,G);const X=e.selectable||"admin"===a.role,Y=(0,c.isTouchDevice)();return t.default.createElement(t.default.Fragment,null,z&&t.default.createElement(f,{element:e}),D&&t.default.createElement(g,{element:e}),t.default.createElement(i.Image,{ref:x,name:"element",id:e.id,image:O,x:e.a.x,y:e.a.y,width:e.a.width||1,height:e.a.height||1,rotation:e.a.rotation,opacity:G,shadowEnabled:e.shadowEnabled,shadowBlur:e.shadowBlur,shadowOffsetX:e.shadowOffsetX,shadowOffsetY:e.shadowOffsetY,shadowColor:e.shadowColor,shadowOpacity:e.shadowOpacity,customCrop:_,listening:X,draggable:Y?e.draggable&&y:e.draggable,preventDefault:!Y||y,hideInExport:!e.showInExport,onDragMove:t=>{e.set({x:t.target.x(),y:t.target.y()})},onDragEnd:t=>{e.set({x:t.target.x(),y:t.target.y()})},onTransformStart:()=>w(!0),onTransform:t=>{const a=t.currentTarget,r=Math.abs(a.scaleX()-1)<1e-7?1:a.scaleX(),i=Math.abs(a.scaleY()-1)<1e-7?1:a.scaleY();a.scaleX(1),a.scaleY(1),e.set({x:a.x(),y:a.y(),width:a.width()*r,height:a.height()*i,rotation:a.rotation()})},onTransformEnd:()=>w(!1)}),t.default.createElement(i.Rect,{x:e.a.x,y:e.a.y,width:Math.max(e.a.width-e.borderSize,0),height:Math.max(e.a.height-e.borderSize,0),opacity:G,offsetX:-e.borderSize/2,offsetY:-e.borderSize/2,stroke:e.borderColor,strokeWidth:e.borderSize,listening:!1,visible:!!e.borderSize,rotation:e.rotation,cornerRadius:Math.max(0,q-e.borderSize),hideInExport:!e.showInExport}))}));