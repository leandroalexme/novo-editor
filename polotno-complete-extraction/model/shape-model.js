Object.defineProperty(exports,"__esModule",{value:!0}),exports.Shape=exports.INDEPENDENT_FILTERS=exports.ShapeFilter=exports.getDiff=exports.Animation=void 0;const e=require("mobx-state-tree"),t=require("../utils/animations"),i=require("mobx"),o=require("./node-model");exports.Animation=e.types.model("Animation",{delay:0,duration:500,enabled:!0,type:e.types.enumeration("Type",["enter","exit","loop"]),name:"none",data:e.types.frozen({})}),exports.getDiff=(e,t)=>{const i={};for(const o in t){if("number"==typeof e[o]&&"number"==typeof t[o]){const n=t[o]-e[o];0!==n&&(i[o]=n)}}return i},exports.ShapeFilter=e.types.model("ShapeFilter",{intensity:1}),exports.INDEPENDENT_FILTERS=["temperature","contrast","highlights","shadows","white","black","saturation","vibrance"],exports.Shape=o.Node.named("Shape").props({x:0,y:0,width:100,height:100,rotation:0,opacity:1,animations:e.types.array(exports.Animation),blurEnabled:!1,blurRadius:10,brightnessEnabled:!1,brightness:0,sepiaEnabled:!1,grayscaleEnabled:!1,filters:e.types.map(exports.ShapeFilter),shadowEnabled:!1,shadowBlur:5,shadowOffsetX:0,shadowOffsetY:0,shadowColor:"black",shadowOpacity:1,visible:!0,draggable:!0,resizable:!0,selectable:!0,contentEditable:!0,styleEditable:!0,alwaysOnTop:!1,showInExport:!0}).preProcessSnapshot((e=>{const t=Object.assign(Object.assign({},e),{x:e.x||0,y:e.y||0,filters:Array.isArray(e.filters)?{}:e.filters});return"width"in e&&(t.width=t.width||1),"height"in e&&(t.height=t.height||1),e.locked&&(t.draggable=!1,t.contentEditable=!1,t.styleEditable=!1,t.resizable=!1,t.removable=!1),t})).views((e=>{const o=(0,i.observable)({x:e.x,y:e.y,width:e.width,height:e.height,rotation:e.rotation,opacity:e.opacity,color:e.color,fontSize:e.fontSize}),n=(0,i.action)((e=>{Object.assign(o,e)})),a=(0,i.action)((e=>{for(const t in e){"number"==typeof o[t]&&(o[t]=o[t]+e[t])}}));return{get a(){const{currentTime:i}=e.store;if(n({x:e.x,y:e.y,width:e.width,height:e.height,rotation:e.rotation,opacity:e.opacity,color:e.color,fontSize:e.fontSize,cropX:e.cropX,cropY:e.cropY,cropWidth:e.cropWidth,cropHeight:e.cropHeight}),0===i){return o}const r=i-e.page.startTime;if(r>e.page.duration){return o}if(r<0){return o}const s=e.store.animatedElementsIds;if(s.length&&!s.includes(e.id)){return o}const l=e.animations.find((e=>"enter"===e.type)),d=(null==l?void 0:l.enabled)&&r<l.delay;d&&n({opacity:0});const p=(null==l?void 0:l.enabled)&&r>=l.delay&&r<=l.delay+l.duration;if(p){const i=r-l.delay,o=(0,t.animate)({element:e,animation:l,dTime:i}),n=(0,exports.getDiff)(e,o);a(n)}const c=e.animations.find((e=>"exit"===e.type));if(!d&&!p&&(null==c?void 0:c.enabled)&&r>=e.page.duration-c.duration-c.delay&&r<=e.page.duration-c.delay){const i=r-(e.page.duration-c.duration-c.delay),o=(0,t.animate)({element:e,animation:c,dTime:i}),n=(0,exports.getDiff)(e,o);a(n)}(null==c?void 0:c.enabled)&&r>=e.page.duration-c.delay&&n({opacity:0});const h=e.animations.find((e=>"loop"===e.type));if(null==h?void 0:h.enabled){const i=r,o=(0,t.animate)({element:e,animation:h,dTime:i}),n=(0,exports.getDiff)(e,o);a(n)}return o},animated:t=>e.a[t]}})).actions((e=>({setAnimation(t,i){const o=e.animations.find((e=>e.type===t));o?Object.assign(o,i):e.animations.push(Object.assign({type:t},i))},setFilter(t,i){exports.INDEPENDENT_FILTERS.includes(t)||e.filters.forEach(((t,i)=>{exports.INDEPENDENT_FILTERS.includes(i.toString())||e.filters.delete(i.toString())})),null==i?e.filters.delete(t):e.filters.set(t,{intensity:i})}})));