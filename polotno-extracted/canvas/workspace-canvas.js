var e=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.WorkspaceCanvas=void 0;const t=e(require("react")),r=require("mobx-react-lite"),n=e(require("./page")),a=require("./rules"),o=require("./audio"),l=require("./hotkeys"),i=require("../utils/l10n"),s=({store:e})=>t.default.createElement("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",textAlign:"center"}},t.default.createElement("p",null,(0,i.t)("workspace.noPages")),t.default.createElement("button",{onClick:()=>{e.addPage()}},(0,i.t)("workspace.addPage"))),u=({width:e,height:r,xPadding:n,yPadding:a,backgroundColor:o})=>t.default.createElement("div",{style:{width:e+"px",height:r+"px",backgroundColor:o,paddingLeft:n+"px",paddingRight:n+"px",paddingTop:a+"px",paddingBottom:a+"px"}},t.default.createElement("div",{style:{width:" 100%",height:"100%",backgroundColor:"white"}})),c=[4,6];exports.WorkspaceCanvas=(0,r.observer)((({store:e,pageControlsEnabled:r,backgroundColor:i,pageBorderColor:d,activePageBorderColor:f,bleedColor:h,snapGuideStroke:g,snapGuideStrokeWidth:p,snapGuideDash:m,selectionRectFill:v,selectionRectStroke:w,selectionRectStrokeWidth:b,transformLabelFill:k,transformLabelTextFill:x,components:y,onKeyDown:E,paddingX:P,paddingY:T,altCloneEnabled:R=!0,visiblePagesOffset:C,renderOnlyActivePage:M})=>{var L;const S=null!=P?P:20,_=null!=T?T:55,[W,F]=t.default.useState({width:100,height:100}),O=t.default.useRef(W),q=t.default.useRef(null),z=t.default.useRef(null),B=e.bleedVisible?Math.max(0,...e.pages.map((e=>e.bleed))):0,G=Math.max(...e.pages.map((e=>e.computedWidth))),H=Math.max(...e.pages.map((e=>e.computedHeight))),D=(null===(L=e.activePage)||void 0===L?void 0:L.computedHeight)||0,N=G+2*B,A=(M?D:H)+2*B,I=async({skipTimeout:t}={skipTimeout:!1})=>{if(t||await new Promise((e=>setTimeout(e,50))),null===q.current){return}const r=q.current.getBoundingClientRect();0!==r.width&&0!==r.height||(console.warn("Polotno warning: <Workspace /> component can not automatically detect its size.\nWidth or height of parent elements is equal 0.\nPlease make sure it has non-zero size. You may need to adjust it with your styles. <Workspace /> will automatically fit into parent container.\nFor simpler debugging here is the log of the parent element:"),console.log(q.current));const n=z.current.clientWidth||r.width,a={width:n,height:r.height};(O.current.width!==a.width||O.current.height!==a.height)&&(F(a),O.current=a);const o=(n-2*S)/N,l=e.pages.length>1?3.1:2,i=(r.height-_*l)/A,s=e.pages.length?Math.max(Math.min(o,i),.01):1;e.scaleToFit!==s&&(e.setScale(s),e._setScaleToFit(s))};t.default.useLayoutEffect((()=>{I({skipTimeout:!0})}),[]),t.default.useEffect((()=>{I()}),[N,A]),t.default.useEffect((()=>{e.__()}),[]),t.default.useEffect((()=>{const e=q.current;if(window.ResizeObserver){const t=new ResizeObserver((()=>{I({skipTimeout:!0})}));return t.observe(e),()=>t.unobserve(e)}{const e=setInterval((()=>{I({skipTimeout:!0})}),100);return()=>clearInterval(e)}}),[N,A]);const K=Math.max(S,(W.width-N*e.scale)/2),Y=M?1:e.pages.length,j=A*e.scale*Y,V=Math.max(_,(W.height-j)/Y/2);t.default.useEffect((()=>{const t=t=>{(E||l.handleHotkey)(t,e)};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)}),[]),t.default.useEffect((()=>{var t;const r=t=>{if(t.ctrlKey||t.metaKey){t.preventDefault();const o=Math.max(5,e.scaleToFit),l=Math.min(.1,e.scaleToFit),i=.03,s=(r=t.deltaY<0?e.scale*(1+i):e.scale/(1+i),n=l,a=o,Math.max(n,Math.min(a,r)));e.setScale(s)}else{var r,n,a}};return null===(t=z.current)||void 0===t||t.addEventListener("wheel",r),()=>{var e;return null===(e=z.current)||void 0===e?void 0:e.removeEventListener("wheel",r)}}),[]);const X=t.default.useRef(!1);((e,r,n,a,o,l)=>{const i=t.default.useRef({width:r,height:n}),s=t.default.useRef({top:0,left:0}),u=t.default.useRef(!1),c=t.default.useRef(o.pages.length);u.current=c.current!==o.pages.length,c.current=o.pages.length,t.default.useEffect((()=>{const t=e.current,r=e=>{s.current={top:t.scrollTop,left:t.scrollLeft}};return t.addEventListener("scroll",r),()=>{t.removeEventListener("scroll",r)}}),[]),t.default.useLayoutEffect((()=>{if(!e.current){return}if(u.current){return}const t=e.current,a=(s.current.left+t.offsetWidth/2)/i.current.width,o=(s.current.top+t.offsetHeight/2)/i.current.height;l.current=!0,t.scrollLeft=a*r-t.offsetWidth/2,t.scrollTop=o*n-t.offsetHeight/2,i.current={width:r,height:n}}),[a,r,n])})(z,N*e.scale+2*K,A*e.scale+2*V,e.scale,e,X);const{handleScroll:J}=((e,r,n,a,o,l)=>{const i=t.default.useRef(!1),s=t.default.useRef(null),u=t.default.useRef(!1);t.default.useEffect((()=>{const t=e.current,r=()=>{o.current};return t.addEventListener("scroll",r),()=>{t.removeEventListener("scroll",r)}}),[]);const c=n.pages.indexOf(n.activePage);return t.default.useLayoutEffect((()=>{if(l){return}if(!n.activePage){return}if(!e.current){return}if(i.current){return}const t=e.current,a=n.pages.indexOf(n.activePage)*r;let o=()=>{};return(Math.abs(a-t.scrollTop)>.5*r||u.current)&&(u.current=!0,o=(({element:e,scrollTop:t=0,duration:r=300,onFinish:n=()=>{}})=>{const a=e.scrollTop,o=t-a;let l=0,i=!1;if(0===r){return e.scrollTop=t,()=>{}}const s=()=>{if(i){return}l+=20;const t=u(l,a,o,r);e.scrollTop=t,l<r?setTimeout(s,20):n()},u=(e,t,r,n)=>(e/=n/2)<1?r/2*e*e+t:-r/2*(--e*(e-2)-1)+t;return s(),()=>{i=!0}})({element:t,scrollTop:a,onFinish:()=>{u.current=!1},duration:n.isPlaying?0:300})),o}),[n.activePage,c,n.isPlaying,l]),{handleScroll:e=>{if(l){return}if(u.current){return}i.current=!0,clearTimeout(s.current),s.current=setTimeout((()=>{i.current=!1}),300);const t=e.currentTarget.childNodes[0].offsetHeight,r=e.currentTarget.scrollTop,o=Math.floor((r+a.height/3)/t),c=n.pages[o];c&&n.activePage!==c&&c.select()}}})(z,A*e.scale+2*V,e,W,X,M),Q=W.width>=N*e.scale+2*K,U=i||"rgba(232, 232, 232, 0.9)",Z=e.pages.indexOf(e.activePage),$=(null==y?void 0:y.NoPages)||s,ee=null!=C?C:Math.min(3,Math.max(1,Math.ceil(W.height/2/(A*e.scale))));return t.default.createElement("div",{ref:q,style:{width:"100%",height:"100%",position:"relative",outline:"none",flex:1,backgroundColor:U,overflow:"hidden"},tabIndex:0,className:"polotno-workspace-container"},t.default.createElement("div",{ref:z,onScroll:J,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",overflow:"auto",overflowX:Q?"hidden":"auto"},className:"polotno-workspace-inner"},e.pages.map(((a,o)=>{const l=a===e.activePage;if(M&&!l&&!a._exportingOrRendering&&!a._forceMount){return null}if(!(Math.abs(o-Z)<=ee||a._exportingOrRendering||a._forceMount)){return t.default.createElement(u,{key:a.id,width:N*e.scale+2*K,height:A*e.scale+2*V,backgroundColor:U,xPadding:K,yPadding:V})}const i=t.default.createElement(n.default,{key:a.id,page:a,xPadding:K,yPadding:V,width:N*e.scale+2*K,height:A*e.scale+2*V,store:e,pageControlsEnabled:r,backColor:U,pageBorderColor:d||"lightgrey",activePageBorderColor:f||"rgb(0, 161, 255)",altCloneEnabled:R,bleedColor:h||"rgba(255, 0, 0, 0.1)",selectionRectFill:v,selectionRectStroke:w,selectionRectStrokeWidth:b,snapGuideStroke:g||"rgb(0, 161, 255)",snapGuideStrokeWidth:p||1,snapGuideDash:m||c,transformLabelFill:k,transformLabelTextFill:x,components:y,viewportSize:W});return(a._exportingOrRendering||a._forceMount)&&!l&&M?t.default.createElement("div",{style:{display:"none"},key:a.id},i):i})),e.rulesVisible&&t.default.createElement(a.TopRules,{store:e,xPadding:K,yPadding:V,width:N*e.scale+2*K,height:A*e.scale+2*V}),0===e.pages.length&&t.default.createElement($,{store:e}),e.audios.map((r=>t.default.createElement(o.AudioElement,{key:r.id,audio:r,store:e})))))})),exports.default=exports.WorkspaceCanvas;