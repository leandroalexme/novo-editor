Object.defineProperty(exports,"__esModule",{value:!0}),exports.Page=void 0;const e=require("mobx-state-tree"),t=require("nanoid"),n=require("./group-model"),i=require("./store"),o=require("./group-model"),r=require("../utils/math");exports.Page=e.types.model("Page",{id:e.types.identifier,children:e.types.array(e.types.late((()=>n.ElementTypes))),width:e.types.optional(e.types.union(e.types.number,e.types.literal("auto")),"auto"),height:e.types.optional(e.types.union(e.types.number,e.types.literal("auto")),"auto"),background:"white",bleed:0,custom:e.types.frozen(),duration:5e3,_exporting:!1,_rendering:!1,_forceMount:!1}).postProcessSnapshot((e=>{const t=Object.assign({},e),n={};for(var i in t){"_"!==i[0]&&(n[i]=e[i])}return n})).views((t=>({get store(){return(0,e.getParentOfType)(t,i.Store)}}))).views((e=>({get startTime(){let t=0;for(const n of e.store.pages){if(n.id===e.id){return t}t+=n.duration}return t},get _exportingOrRendering(){return e._exporting||e._rendering}}))).views((e=>({get computedWidth(){return"auto"===e.width?e.store.width:e.width},get computedHeight(){return"auto"===e.height?e.store.height:e.height}}))).actions((t=>({toJSON:()=>JSON.parse(JSON.stringify((0,e.getSnapshot)(t))),_forEachElementUp(e,n){const i=e.map((e=>({id:e,index:t.children.findIndex((t=>t.id===e))})));i.sort(((e,t)=>t.index-e.index));for(const{index:o}of i){if(-1==o){continue}const i=o<t.children.length-1&&t.children[o+1],r=e.indexOf(null==i?void 0:i.id)>=0;o===t.children.length-1||r||n(o)}},_forEachElementDown(e,n){const i=e.map((e=>({id:e,index:t.children.findIndex((t=>t.id===e))})));i.sort(((e,t)=>e.index-t.index));for(const{index:o}of i){if(-1==o){continue}const i=o>0&&t.children[o-1],r=e.indexOf(null==i?void 0:i.id)>=0;0===o||r||n(o)}return!1}}))).actions((n=>({clone(e={}){const i=n.toJSON();i.children.forEach((e=>{e.id=(0,t.nanoid)(10),(0,o.forEveryChild)(e,(e=>{e.id=(0,t.nanoid)(10)}))}));const r=Object.assign(Object.assign(Object.assign({},i),{id:(0,t.nanoid)(10)}),e),d=n.store.addPage(r),s=n.store.pages.indexOf(n);return d.setZIndex(s+1),d.select(),d},setZIndex(e){n.store.setPageZIndex(n.id,e)},set(e){Object.assign(n,e)},select(){n.store.selectPage(n.id)},addElement(e,{skipSelect:i=!1}={}){const r=o.TYPES_MAP[e.type];if(!r){return void console.error("Can not find model with type "+e.type)}"children"in e&&Array.isArray(e.children)&&(0,o.forEveryChild)(e,(e=>{e.id=e.id||(0,t.nanoid)(10)}));const d=r.create(Object.assign({id:(0,t.nanoid)(10)},e));return n.children.push(d),d.selectable&&!i&&n.store.selectElements([d.id]),d},canMoveElementsUp(e){let t=!1;return n._forEachElementUp(e,(()=>{t=t||!0})),t},moveElementsUp(t){n._forEachElementUp(t,(t=>{const i=n.children[t];(0,e.detach)(i),n.children.splice(t+1,0,i)}))},canMoveElementsTop(e){return this.canMoveElementsUp(e)},moveElementsTop(e){const t=[],i=[];n.children.forEach((n=>{e.indexOf(n.id)>=0?t.push(n):i.push(n)})),n.children.replace(i.concat(t))},canMoveElementsDown(e){let t=!1;return n._forEachElementDown(e,(()=>{t=t||!0})),t},moveElementsDown(t){n._forEachElementDown(t,(t=>{const i=n.children[t];(0,e.detach)(i),n.children.splice(t-1,0,i)}))},canMoveElementsBottom(e){return this.canMoveElementsDown(e)},moveElementsBottom(e){const t=[],i=[];n.children.forEach((n=>{e.indexOf(n.id)>=0?t.push(n):i.push(n)})),n.children.replace(t.concat(i))},setElementZIndex(t,i){const o=n.children.find((e=>e.id===t));o&&((0,e.detach)(o),n.children.remove(o),n.children.splice(i,0,o))},setSize({width:e,height:t,useMagic:i,softChange:d}){if(i){const i=[],d=e=>"image"===e.type&&e.x<1&&e.y<1&&e.width>=n.computedWidth-2&&e.height>=n.computedHeight-2;(0,o.forEveryChild)(n,(e=>{"group"!==e.type&&(d(e)||i.push(e))}));const s=i.length?(0,r.getTotalClientRect)(i):{x:0,y:0,width:n.computedWidth,height:n.computedHeight},a=1/4,c=Math.max(0,Math.min(s.x,n.computedWidth-s.x-s.width)),h=n.computedWidth*a,l=Math.max(0,c-h),p=Math.max(0,Math.min(s.y,n.computedHeight-s.y-s.height)),m=n.computedHeight*a,u=Math.max(0,p-m),g=n.computedWidth-2*l,E=n.computedHeight-2*u,f=e/g,y=t/E,v=Math.min(f,y),x=(e-g*v)/2-l*v,w=(t-E*v)/2-u*v;(0,o.forEveryChild)(n,(e=>{"group"!==e.type&&(d(e)?e.set({x:e.x*v,y:e.y*v,width:e.width*f,height:e.height*y,cropX:0,cropY:0,cropWidth:1,cropHeight:1}):(e.set({x:x+e.x*v,y:w+e.y*v,width:e.width*v,height:e.height*v}),"text"===e.type?e.set({fontSize:e.fontSize*v}):"figure"===e.type&&e.set({strokeWidth:e.strokeWidth*v})))}))}d||(n.width=e),d||(n.height=t)}}))).actions((e=>({moveElementUp(t){console.warn("page.moveElementUp(id) is deprecated. Please use page.moveElementsUp([id1, id2]) instead."),e.moveElementsUp([t])},moveElementDown(t){console.warn("page.moveElementDown(id) is deprecated. Please use page.moveElementsDown([id1, id2]) instead."),e.moveElementsDown([t])},moveElementTop(t){console.warn("page.moveElementTop(id) is deprecated. Please use page.moveElementsTop([id1, id2]) instead."),e.moveElementsTop([t])},moveElementBottom(t){console.warn("page.moveElementBottom(id) is deprecated. Please use page.moveElementsBottom([id1, id2]) instead."),e.moveElementsBottom([t])},play(){e.store.play({startTime:e.startTime,endTime:e.startTime+e.duration})}})));