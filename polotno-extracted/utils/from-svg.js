var t=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.svgToURL=h,exports.svgToJson=async function(t){const e=document.createElement("div");document.body.appendChild(e),e.innerHTML=t;const n=e.querySelector("svg"),{width:i,height:g}=o(n),s=[];for(const r of Array.from(n.children)){s.push(...await m(r))}return e.parentElement.removeChild(e),{width:i,height:g,pages:[{id:r(),children:s}]}};const e=t(require("konva")),n=require("./image");let i=0;const r=()=>(i+=1,i.toString());function o(t){const e=t.getAttribute("viewBox"),[n,i,r,o]=(null==e?void 0:e.split(" "))||[];return(!t.getAttribute("width")||t.getAttribute("width").indexOf("%")>=0)&&t.setAttribute("width",r+"px"),(!t.getAttribute("height")||t.getAttribute("height").indexOf("%")>=0)&&t.setAttribute("height",o+"px"),{width:parseFloat(t.getAttribute("width")||r),height:parseFloat(t.getAttribute("height")||o)}}function g(t){const n=function(t){var n,i,r;const o=(null===(r=null===(i=null===(n=t.transform)||void 0===n?void 0:n.baseVal)||void 0===i?void 0:i.consolidate())||void 0===r?void 0:r.matrix)||new DOMMatrix;return new e.default.Transform([o.a,o.b,o.c,o.d,o.e,o.f])}(t);return t.parentNode&&"svg"!==t.parentNode.nodeName?g(t.parentNode).multiply(n):n}function s(t){return g(t).decompose()}function a(t){const{x:e,y:n}=t.getBoundingClientRect();if("svg"===t.nodeName){return{x:e,y:n}}const i=a(t.parentNode);return{x:e+i.x,y:n+i.y}}function u(t){return t.getElementsByTagName("text").length>0}function l(t){const e=[...t.getElementsByTagName("rect")].find((t=>{const e=t.getAttribute("fill");return e&&e.indexOf("url")>=0}));return t.getElementsByTagName("image").length>0||e}function h(t){return"data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(t)))}const d=t=>"g"===t.nodeName&&t.getBBox().width<450&&t.getBBox().height<450;function c(t="url(#pattern)"){return t.replace(/url\(([^)]+)\)/,"$1").replace(/'/g,"")}function f(t){if(!t){return"Roboto"}if(t.includes("OpenSans")){return"Open Sans"}if(t.includes("Montserrat")){return"Montserrat"}const e=t.split(",").map((t=>t.trim()));return e[1]||e[0]}function x(t){return t.parentNode&&"svg"===t.parentNode.nodeName?t.parentNode:x(t.parentElement)}async function m(t){if("defs"===t.nodeName){return[]}const e=t.getAttribute("id")||r();if("text"===t.nodeName){let n=Array.from(t.children).map((t=>t.textContent));0===n.length&&(n=[t.textContent]);const i=n.join("\n"),r=parseFloat(t.getAttribute("font-size")||t.style.fontSize||"20"),{x:o,y:g,rotation:a}=s(t),u=t.getAttribute("text-anchor")||"start";let l="left";return"middle"===u?l="center":"end"===u&&(l="right"),[{type:"text",text:i,id:e,x:o+t.getBBox().x,y:g+t.getBBox().y,fontSize:r,rotation:a,lineHeight:t.getBBox().height/n.length/r,width:t.getBBox().width,height:t.getBBox().height,fontFamily:f(t.getAttribute("font-family")),fontWeight:t.getAttribute("font-weight")||"normal",fontStyle:t.getAttribute("font-style")||"normal",align:l,fill:t.getAttribute("fill")||t.style.fill||"black"}]}if("image"===t.nodeName){const{x:i,y:r,rotation:o,scaleX:g,scaleY:a}=s(t),u=t.getBBox().width*g,l=t.getBBox().height*a,h=t.getAttribute("xlink:href")||"",d=await(0,n.getImageSize)(h),c=(0,n.getCrop)({width:u,height:l},d);return[Object.assign({type:"image",id:e,x:i+t.getBBox().x,y:r+t.getBBox().y,width:u,height:l,src:h,rotation:o},c)]}if("rect"===t.nodeName){const{x:i,y:r,rotation:o}=s(t),g=parseFloat(t.getAttribute("width")||"0"),a=parseFloat(t.getAttribute("height")||"0"),u=t.getAttribute("fill")||"",l=u.indexOf("url")>=0,d=l&&c(u),f=document.querySelector(d);if(l){const s=null==f?void 0:f.querySelector("use"),u=null==s?void 0:s.getAttribute("xlink:href"),l=u&&document.querySelector(u);if(l){const s=l.getAttribute("xlink:href"),u=await(0,n.getImageSize)(s),h=(0,n.getCrop)({width:g,height:a},u);return[Object.assign({type:"image",id:e,x:i+t.getBBox().x,y:r+t.getBBox().y,width:g,height:a,src:s,rotation:o},h)]}}t.setAttribute("transform","");const x=t.getBBox();t.setAttribute("x","0"),t.setAttribute("y","0");const m=`<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${g}" height="${a}" viewBox="0 0 ${g} ${a}">${(null==f?void 0:f.outerHTML)||""}${t.outerHTML}</svg>`;return[{type:"svg",id:e,x:i+x.x,y:r+x.y,width:g,height:a,src:h(m)}]}if("path"===t.nodeName||"polygon"===t.nodeName||"circle"===t.nodeName){const{x:n,y:i,rotation:r,scaleX:o,scaleY:g}=s(t),a=t.getBBox(),{width:u,height:l}=a;t.setAttribute("transform","");const d=t.getAttribute("fill")||"",f=d.indexOf("url")>=0&&c(d),x=document.querySelector(f);let m=x?[x]:[];if(x&&x.getAttribute("xlink:href")){m=[x];const t=document.querySelector(x.getAttribute("xlink:href"));t&&m.push(t)}const w=`<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${u}" height="${l}" viewBox="0 0 ${u} ${l}"><defs>${m.map((t=>t.outerHTML)).join("")}</defs><g transform="translate(${-a.x} ${-a.y})">${t.outerHTML}</g></svg>`;return[{type:"svg",id:e,x:n+a.x*o,y:i+a.y*g,width:u*o,height:l*g,rotation:r,src:h(w)}]}if(d(t)&&!u(t)&&!l(t)){const{x:n,y:i}=t.getBBox(),{width:r,height:g}=(a(t),t.getBBox()),s=Array.from(t.querySelectorAll("*"));let u=n,l=i;s.forEach((t=>{if("g"===t.nodeName){return}const e=t.getBBox();u=Math.min(u,e.x),l=Math.min(l,e.y)}));const d=t.getBoundingClientRect(),c=x(t),f=null==c?void 0:c.getBoundingClientRect(),m=t.getAttribute("transform");t.setAttribute("transform","");const w=`<svg xmlns="http://www.w3.org/2000/svg" width="${r}" height="${g}" viewBox="0 0 ${r} ${g}"><g transform="translate(${-n} ${-i})">${t.outerHTML}</g></svg>`;t.setAttribute("transform",m);const y=o(x(t));return[{type:"svg",id:e,x:(d.x-f.x)/f.width*y.width,y:(d.y-f.y)/f.height*y.height,width:r,height:g,name:t.getAttribute("id")||"",src:h(w)}]}if(!u(t)&&!l(t)){const e=[];for(const n of Array.from(t.children)){e.push(...await m(n))}return e}const i=[];for(const n of Array.from(t.children)){i.push(...await m(n))}return i}