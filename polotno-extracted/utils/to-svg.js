var e,t=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),n=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||(e=function(t){return e=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e){Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n)}return t},e(t)},function(r){if(r&&r.__esModule){return r}var o={};if(null!=r){for(var i=e(r),a=0;a<i.length;a++){"default"!==i[a]&&t(o,r,i[a])}}return n(o,r),o}),o=this&&this.__rest||function(e,t){var n={};for(var r in e){Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r])}if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++){t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(n[r[o]]=e[r[o]])}}return n};Object.defineProperty(exports,"__esModule",{value:!0}),exports.forEveryChild=void 0,exports.fixRatio=function(e){var t=(new DOMParser).parseFromString(e,"image/svg+xml");return t.documentElement.setAttribute("preserveAspectRatio","none"),(new XMLSerializer).serializeToString(t)},exports.jsonToDOM=m,exports.jsonToSVG=async function({json:e,elementHook:t}){const n=await m({json:e,elementHook:t});return y({dom:n})};const i=require("./image"),a=r(require("./svg")),s=require("./image"),l=require("./figure-to-svg"),h=require("./filters");exports.forEveryChild=(e,t)=>{if(e.children){for(const n of e.children){if(!0===t(n)){break}(0,exports.forEveryChild)(n,t)}}};const c=(e,t,...n)=>({type:e,props:t,children:n||[]}),g=async({element:e,page:t,store:n})=>{let{src:r}=e;if("svg"===e.type){const t=await a.urlToString(r);r=a.replaceColors(t,new Map(Object.entries(e.colorsReplace)))}else{r=await(async e=>{try{const t=await fetch(e);if("undefined"!=typeof Buffer){const e=await t.arrayBuffer(),n=Buffer.from(e).toString("base64");return`data:${t.headers.get("content-type")||"image/png"};base64,${n}`}{const e=await t.blob();return new Promise(((t,n)=>{const r=new FileReader;r.onloadend=()=>t(r.result),r.onerror=n,r.readAsDataURL(e)}))}}catch(t){return console.error("Error converting URL to data URL:",t),e}})(r)}let o="";e.flipX&&(o+="scaleX(-1)"),e.flipY&&(o+="scaleY(-1)");const i={};if(e.clipSrc){const t=await a.urlToBase64(e.clipSrc);i["clip-path"]=`url(${t})`}const l=await(0,s.loadImage)(r),h=l.width*e.cropWidth,g=l.height*e.cropHeight,p=e.width/e.height;let f,d;const u=h/g;"svg"===e.type?(f=h,d=g):p>=u?(f=h,d=h/p):(f=g*p,d=g);const m=f/l.width,y=d/l.height,w=f/d>e.width/e.height?e.height/d:e.width/f,b=f*w/m,$=d*w/y,x=e.cropX*l.width*w,v=e.cropY*l.height*w,O=`clip-${e.id}`,j=r.replace(/&/g,"&amp;");return c("g",{style:{transform:o}},c("defs",{},c("clipPath",{id:O},c("rect",{x:0,y:0,width:e.width,height:e.height}))),c("image",{href:j,x:-x,y:-v,width:b,height:$,preserveAspectRatio:"none","clip-path":`url(#${O})`}))},p=({element:e,type:t})=>{const n={"stroke-width":e.height,stroke:e.color,"line-cap":"round","stroke-linejoin":"round",opacity:e.opacity};return"arrow"===t||"triangle"===t?c("polyline",Object.assign({points:`${3*e.height},${2*-e.height} 0,0 ${3*e.height},${2*e.height}`},n)):"bar"===t?c("polyline",Object.assign({points:`0,${2*-e.height} 0,${2*e.height}`},n)):"circle"===t?c("circle",Object.assign({r:e.height},n)):"square"===t?c("polyline",Object.assign({points:`${-e.height},${-e.height} ${-e.height},${e.height} ${e.height},${e.height} ${e.height},${-e.height}`},n)):null},f={image:g,svg:g,text:async({element:e,page:t,store:n})=>{const r=(e,t,n,r,o)=>{const i=document.createElement("canvas").getContext("2d");return i.font=`${o} ${r} ${t}px ${n}`,i.measureText(e).width},o=((e,t,n,o,i,a)=>{const s=[];return e.split("\n").forEach((e=>{const l=e.split(" ");let h="";for(let c=0;c<l.length;c++){const e=h+l[c]+" ";r(e,n,o,i,a)>t+.5&&c>0?(s.push(h.trim()),h=l[c]+" "):h=e}s.push(h.trim())})),s})(e.text,e.width,e.fontSize,e.fontFamily,e.fontWeight,e.fontStyle),i=e.fontSize*e.lineHeight,a="center"===e.align?"middle":"right"===e.align?"end":"start",s=o.map(((t,n)=>c("tspan",{x:"center"===e.align?e.width/2:"right"===e.align?e.width:0,dy:0===n?0:i,innerHTML:t})));return c("g",{},c("text",{fill:e.fill,y:e.fontSize,"font-size":e.fontSize+"px","text-anchor":a,"font-family":e.fontFamily,"font-style":e.fontStyle,"font-weight":e.fontWeight,"text-decoration":e.textDecoration,"line-height":e.lineHeight,"letter-spacing":e.letterSpacing+"em","stroke-width":e.strokeWidth,stroke:e.stroke},...s))},line:async({element:e,page:t,store:n})=>c("g",{},c("line",{x1:0,y1:e.height/2,x2:e.width,y2:e.height/2,stroke:e.color,"stroke-width":e.height}),c("g",{transform:`translate(0 ${e.height/2})`},p({element:e,type:e.startHead})),c("g",{transform:`translate(${e.width} ${e.height/2}) rotate(180)`},p({element:e,type:e.endHead}))),figure:async({element:e,page:t,store:n,elementHook:r})=>{const o=function(e){let t=e.replace(/<svg[^>]*>/,"");return t=t.replace(/<\/svg>/,""),t}((0,l.figureToSvg)(e)),i=c("g",{innerHTML:o});return r&&r({dom:i,element:e})||i},group:async({element:e,page:t,store:n,elementHook:r})=>{const o=await Promise.all(e.children.map((e=>d({element:e,page:t,store:n,elementHook:r})))),i=c("g",{opacity:e.opacity,style:{"transform-origin":"top left"}},...o);return r&&r({dom:i,element:e})||i},gif:g};async function d({element:e,page:t,store:n,elementHook:r}){let o=await f[e.type];o||(o=()=>c("g",{}),console.error(`SVG export does not support ${e.type} type...`));const i=await o({element:e,page:t,store:n}),a=[],s=[];if(e.blurEnabled&&a.push(`blur(${e.blurRadius/2}px)`),e.brightnessEnabled&&a.push(`brightness(${100*e.brightness+100}%)`),e.sepiaEnabled&&a.push("sepia()"),e.grayscaleEnabled&&a.push("grayscale()"),e.shadowEnabled&&a.push(`drop-shadow(${e.shadowOffsetX}px ${e.shadowOffsetY}px ${e.shadowBlur}px ${e.shadowColor})`),e.filters){for(const[c,g]of Object.entries(e.filters)){const e=(0,h.shapeFilterToCSS)(h.Effects[c],g.intensity);if(e&&(a.push(e.filter),e.html)){const t=e.html.replace(/<svg([^>]*)>/,"<g$1>").replace(/<\/svg>/,"</g>");s.push(t)}}}const l=c("g",{className:"element",id:e.id,transform:"group"!==e.type?`translate(${e.x}, ${e.y}) rotate(${e.rotation})`:void 0,display:e.visible?void 0:"none",style:{"transform-origin":"top left",filter:a.join(" ")}},i,...s);return r&&r({dom:l,element:e})||l}async function u(e){try{const t=await fetch(e),n=await t.blob();return new Promise(((e,t)=>{const r=new FileReader;r.onloadend=()=>e(r.result),r.onerror=t,r.readAsDataURL(n)}))}catch(t){return console.error("Error embedding font:",t),e}}async function m({json:e,elementHook:t}){const n=await Promise.all(e.pages.map((n=>async function({page:e,store:t,elementHook:n}){const r=await Promise.all(e.children.map((r=>d({element:r,page:e,store:t,elementHook:n})))),o=e.background.indexOf("url")>=0||e.background.indexOf("http")>=0||e.background.indexOf(".jpg")>=0||e.background.indexOf(".png")>=0||e.background.indexOf(".jpeg")>=0;let a;if(o){const n=await(0,s.loadImage)(e.background);a=await(0,s.cropImage)(e.background,Object.assign({width:t.width,height:t.height,x:0,y:0},(0,i.getCrop)({width:t.width,height:t.height},{width:n.width,height:n.height})))}return c("g",{className:"page",style:{}},o?c("image",{"xlink:href":a,x:0,y:0,width:t.width,height:t.height,preserveAspectRatio:"none"}):c("rect",{x:0,y:0,width:t.width,height:t.height,fill:o?void 0:e.background}),...r)}({page:n,store:e,elementHook:t})))),r=[];(0,exports.forEveryChild)({children:e.pages},(e=>{"text"===e.type&&-1===r.indexOf(e.fontFamily)&&r.push(e.fontFamily)}));const o=await async function(e,t){return await Promise.all(e.map((async e=>{var n,r;const o=t.find((t=>t.fontFamily===e));if(o){const t=await u(o.url);return c("style",{},`@font-face { font-family: ${e}; src: url(${t}); }`)}{const t=`https://fonts.googleapis.com/css?family=${e}:bi,normal,i,b`;try{const o=await fetch(t),i=await o.text(),a=null===(r=null===(n=i.match(/url\((.*?)\)/g))||void 0===n?void 0:n.map((e=>e.replace(/url\((.*?)\)/,"$1"))))||void 0===r?void 0:r.filter((e=>e.startsWith("https")));if(!(null==a?void 0:a.length)){throw new Error("No font URLs found")}const s=await Promise.all(a.map((async t=>{const n=await u(t),r=i.match(/font-style:\s*(.*?);/),o=i.match(/font-weight:\s*(.*?);/),a=r?r[1]:"normal",s=o?o[1]:"normal";return`@font-face {\n                font-family: ${e};\n                font-style: ${a};\n                font-weight: ${s};\n                src: url(${n});\n              }`})));return c("style",{},s.join("\n"))}catch(i){return console.error("Error embedding Google Font:",i),c("defs",{},c("style",{type:"text/css",innerHTML:`@import url('${t}');`.replace(/&/g,"&amp;")}))}}})))}(r,e.fonts);return c("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:`0 0 ${e.width} ${e.height}`,width:e.width,height:e.height},...o,...n)}const y=({dom:e,nestLevel:t=0})=>{if("string"==typeof e){return e}if(!e){return""}const n=e.props,{innerHTML:r}=n,i=o(n,["innerHTML"]),a=" ".repeat(t);return`${a}<${e.type} ${Object.keys(i).map((e=>((e,t)=>"object"==typeof t?`${e}="${Object.keys(t).map((e=>`${e}:${t[e]};`)).join(" ")}"`:null==t||""===t?"":`${e}="${t}"`)(e,i[e]))).join(" ")}>${r||"\n"+e.children.map((e=>y({dom:e,nestLevel:t+1}))).join("")}${a}</${e.type}>\n`};